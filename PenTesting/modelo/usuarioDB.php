<?php
require_once ("modelo/usuario.php");
require_once ("modelo/cuenta.php");
require_once ("modelo/empresa.php");

// * importar las clases del modelo
class usuarioDB extends baseDeDatos
{

    function obtenerUsuario($user, $clave)
    {
        $consulta = "SELECT * FROM usuarios WHERE usuario=? AND pass=?";
        if ($pre = $this->conexion->prepare($consulta)) {
            $pre->bind_param("ss", $user, $clave);
            $pre->execute();

            $pre->bind_result($usuario, $pass, $nombre, $apellido, $dni, $empresa, $estado, $telefono, $fecha, $email,$cuenta);

            if ($pre->fetch())
                $usuario = new usuario($usuario, $pass, $nombre, $apellido, $dni, $empresa, $estado, $telefono, $fecha, $email,$cuenta);
            return $usuario;
        } else           
            return false;
    }

    function mostrar2($cuenta, $dia, $empresa)
	//Nos muestra todas las operaciones que ha realizado el usuario, de la mas reciente a la mas antigua con el saldo altual de su cuenta.
    {
        echo "<link rel=stylesheet type=text/css href=estilos/estilos.css>";
        echo "<link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css>";
        echo " <link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css>";

        $sql = "select cuenta_titular,fecha,importe,Saldo,tipo_operacion,motivo from
				operacion where cuenta_titular = ? and (tipo_operacion='cargo' or tipo_operacion='abono') order by num_operacion DESC";

        $resultado = mysqli_query($this->conexion, $sql);

        $pre = mysqli_prepare($this->conexion, $sql);

        mysqli_stmt_bind_param($pre, "s", $cuenta1);

        $cuenta1 = $cuenta;

        mysqli_stmt_execute($pre);

        $result = mysqli_stmt_bind_result($pre, $cuenta_titular, $fecha, $importe, $saldo, $tipo_operacion, $motivo);
        echo $this->obtenerErrorSQL();

        echo "<div id='azul'>";
        echo "<div class='dos'><b><u>POSICI&Oacute;N GLOBAL</u></b></div>";
        echo "<div class='dos'><b><u>IBAN:</u></b>
				" . $cuenta . "</br></div>";
        echo "<div class='dos'><b><u>Empresa</u></b>:" . $empresa . "</div></br></br></br></br></br></br>";
        echo "</div>";
        echo "<div class='row'>";
        echo "<div id='menu' class='col-md-2'>";
        require ("vista/Menu.html");
        echo "</div>";
        echo "</div>";
        echo "<div class='row'>";
        echo "<div class='col-md-10'>";
        echo "<table id='tablita' class='table table-hover'>";
        echo "<tr class='info'>";
        echo "<td><b>Fecha</b></td>";
        echo "<td><b>Concepto</b></td>";
        echo "<td><b>Importe</b></td>";
        echo "<td><b>Saldo</b></td>";
        echo "</tr>";
        while (mysqli_stmt_fetch($pre)) {
            echo "<tr>";
            echo " <td>" . $fecha . "</td><td>
						" . $motivo . "</td><td>" . number_format($importe, 2, ",", ".") . "&euro;</td><td>" . number_format($saldo, 2, ",", ".") . "&euro;</td>";
            echo "</tr>";
        }
        echo "</table>";
        echo "</div>";
        echo "</div>";
    }

    function obtenerCuenta($empresa)
    {
        $consulta = "select cuenta.num_cuenta from cuenta inner join usuarios
				on usuarios.empresa=cuenta.empresa where usuarios.empresa= ?";
        if ($pre = $this->conexion->prepare($consulta)) {

            $pre->bind_param("i", $empresa);
            $pre->execute();

            $pre->bind_result($cuenta);

            if ($pre->fetch())
                $cuent = $cuenta;
            return $cuent;
        } else

            return false;
    }

    function sacar($benefi)
    {
        echo "<link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css>";
        echo " <link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css>";
        $consulta = "SELECT num_cuenta FROM cuenta WHERE num_cuenta= ?";
        if ($pre = $this->conexion->prepare($consulta)) {

            $pre->bind_param("s", $benefi);
            $pre->execute();

            $pre->bind_result($num_cuenta);

            if ($pre->fetch() > 0) {

                return true;
            } else {
                echo "No existe esta cuenta";
                echo "</br><a class='btn btn-danger'href='#' onclick='window.close();'>Cerrar</a>";

                return false;
            }
        }
    }

    function tranfe($titular, $benefi, $importe, $motivo, $hoy)
    {
        echo "<link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css>";
        echo " <link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css>";

        $consulta = "INSERT into operacion (cuenta_titular,beneficiario,fecha,importe,tipo_operacion,motivo) values(?,?,?,?,'transferencia',?)";

        if ($pre = $this->conexion->prepare($consulta)) {
            echo "Tranferencia realizada";
            echo "</br><a class='btn btn-danger'href='#' onclick='window.close();'>Cerrar</a>";
            $pre->bind_param("sssis", $titular, $benefi, $hoy, $importe, $motivo);
            $pre->execute();
            if ($pre->fetch())

                return true;
        } else {
            echo "Tranferencia no realizada";
            echo "</br><a class='btn btn-danger'href='#' onclick='window.close();'>Cerrar</a>";
            return false;
        }
    }

    function sumar($importe, $benefi)
    {
        if (is_numeric($importe)) {
            $sql = "UPDATE cuenta set saldo= saldo + ? where num_cuenta = ?;";
            $pre = mysqli_prepare($this->conexion, $sql);

            // Se indica los datos a reemplazar con su tipo
            mysqli_stmt_bind_param($pre, "ds", $saldo, $bene);

            $saldo = $importe;
            $bene = $benefi;

            echo $this->obtenerErrorSQL();

            if ($result = mysqli_stmt_execute($pre)) {
                if (mysqli_affected_rows($this->conexion) > 0) {} else {}
            }
        } else {}
    }

    function restar($importe, $titular)
    {
        if (is_numeric($importe)) {
            $sql = "UPDATE cuenta set saldo= saldo - ? where num_cuenta = ?;";
            $pre = mysqli_prepare($this->conexion, $sql);

            // Se indica los datos a reemplazar con su tipo
            mysqli_stmt_bind_param($pre, "ds", $saldo, $titu);

            $saldo = $importe;
            $titu = $titular;

            echo $this->obtenerErrorSQL();
            if ($result = mysqli_stmt_execute($pre)) {
                if (mysqli_affected_rows($this->conexion) > 0) {} else {}
            }
        } else {}
    }

    function saldo($cuent)
    {
        echo "<link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css>";
        echo " <link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css>";

        $sql = "SELECT * from cuenta where num_cuenta= ? ";

        if ($pre = $this->conexion->prepare($sql)) {

            $pre->bind_param("s", $cuent);
            $pre->execute();

            $pre->bind_result($numero_cuenta, $saldo, $empresa);

            if ($pre->fetch())
                $cuenta = new cuenta($numero_cuenta, $saldo, $empresa);
            return $cuenta;
        } else

            return false;
    }

    function cargo($titular, $importe, $motivo, $hoy, $saldo)
    {
        if (is_numeric($importe)) {
            echo "<link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css>";
            echo " <link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css>";

            $consulta = "INSERT into operacion (cuenta_titular,fecha,importe,saldo,tipo_operacion,motivo) values(?,?,-?,?,'cargo',?)";

            if ($pre = $this->conexion->prepare($consulta)) {

                $pre->bind_param("ssdds", $titular, $hoy, $importe, $saldo, $motivo);
                $pre->execute();
                if ($pre->fetch())
                    return true;
            } else {
                echo "Cargo no realizada";
                echo "</br><a class='btn btn-danger' href='index.php?vista=comprobar1'>Volver</a>";

                return false;
            }
        } else {}
    }

    function abono($titular, $importe, $motivo, $hoy, $saldo)
    {
        if (is_numeric($importe)) {
            echo "<link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css>";
            echo " <link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css>";

            $consulta = "INSERT into operacion (cuenta_titular,fecha,importe,saldo,tipo_operacion,motivo) values(?,?,?,?,'abono',?)";

            if ($pre = $this->conexion->prepare($consulta)) {
                echo "Transferencia realizada";
                echo "</br><a class='btn btn-danger'href='#' onclick='window.close();'>Cerrar</a>";
                $pre->bind_param("ssdds", $titular, $hoy, $importe, $saldo, $motivo);
                $pre->execute();
                if ($pre->fetch())
                    return true;
            } else {
                echo "Abono no realizada";
                echo "</br><a class='btn btn-danger'href='#' onclick='window.close();'>Cerrar</a>";

                return false;
            }
        } else {
            echo "importe no correcto";
            echo "</br><a class='btn btn-danger'href='#' onclick='window.close();'>Cerrar</a>";
        }
    }

    function mostrar1($empresa, $dia)
    {
        echo "<link rel=stylesheet type=text/css href=estilos/estilos.css>";
        echo "<link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css>";
        echo " <link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css>";

        $sql = "select cuenta_titular,fecha,importe,operacion.Saldo,tipo_operacion,motivo from
				operacion inner join cuenta on operacion.cuenta_titular=cuenta.num_cuenta inner join empresa on 
				cuenta.Empresa=empresa.Id_empresa where empresa.Nombre= ? order by num_operacion DESC;";

        $resultado = mysqli_query($this->conexion, $sql);

        $pre = mysqli_prepare($this->conexion, $sql);

        mysqli_stmt_bind_param($pre, "s", $empresa1);

        $empresa1 = $empresa;

        mysqli_stmt_execute($pre);

        $result = mysqli_stmt_bind_result($pre, $cuenta_titular, $fecha, $importe, $saldo, $tipo_operacion, $motivo);

        echo "<div class='dos'><b><u>Movimientos cuenta</u></b></div>";
        echo "<div class='dos'><b><u>Extrato de su cuenta</u></b></br>
				<b>Nombre de la empresa</b>:" . $empresa . "</br></div>";
        echo "<div class='dos'><b><u>Fecha</u></b>:" . $dia . "</div>";
        echo "<table class='table table-hover'>";
        echo "<tr class='info'>";
        echo "<td><b>Fecha</b></td>";
        echo "<td><b>Concepto</b></td>";
        echo "<td><b>Importe</b></td>";
        echo "<td><b>Saldo</b></td>";
        echo "</tr>";
        while (mysqli_stmt_fetch($pre)) {
            echo "<tr>";
            echo " <td>" . $fecha . "</td><td>
						" . $motivo . "</td><td>" . $importe . "&euro;</td><td>" . number_format($saldo, 2, ",", ".") . "&euro;</td>";
            echo "</tr>";
        }
        echo "</table>";
        echo "<a class='btn btn-danger' href='index.php?vista=comprobar2'>Volver</a>";
    }

    function mostrar3($empresa)
    {
        echo "<link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css>";
        echo " <link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css>";

        $sql = "select cuenta_titular,beneficiario,fecha,importe,operacion.Saldo,tipo_operacion,motivo from
				operacion inner join cuenta on operacion.cuenta_titular=cuenta.num_cuenta inner join empresa on
				empresa.Id_empresa=cuenta.Empresa where empresa.Nombre= ? and
				(tipo_operacion='transferencia')order by fecha,num_operacion";

        $resultado = mysqli_query($this->conexion, $sql);

        $pre = mysqli_prepare($this->conexion, $sql);

        mysqli_stmt_bind_param($pre, "s", $empresa1);

        $empresa1 = $empresa;

        mysqli_stmt_execute($pre);

        $result = mysqli_stmt_bind_result($pre, $cuenta_titular, $beneficiario, $fecha, $importe, $saldo, $tipo_operacion, $motivo);
        echo $this->obtenerErrorSQL();

        while (mysqli_stmt_fetch($pre)) {
            echo "<b>Cuenta titular: </b> " . $cuenta_titular . "<b>Beneficiario: </b>" . $beneficiario . " <b> fecha: </b> " . $fecha . "<b> importe: </b>
						" . $importe . "<b> Saldo: </b>" . number_format($saldo, 2, ",", ".") . "<b>&euro;</b><b> tipo de operacion: </b>" . $tipo_operacion . " <b>concepto: </b>" . $motivo . "</br>";
        }
        echo "<a class='btn btn-danger' href='index.php?vista=comprobar2'>Volver</a>";
    }

    function cargoadmin($benefi, $importe, $motivo, $hoy, $saldo)
    {
        echo "<link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css>";
        echo " <link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css>";

        $consulta = "INSERT into operacion (cuenta_titular,fecha,importe,Saldo,tipo_operacion,motivo) values(?,?,-?,?,'cargo',?)";

        if ($pre = $this->conexion->prepare($consulta)) {
            echo "Cargo realizado";
            echo "</br><a class='btn btn-danger' href='index.php?vista=comprobar2'>Volver</a>";
            $pre->bind_param("ssdds", $benefi, $hoy, $importe, $saldo, $motivo);
            $pre->execute();
            if ($pre->fetch())
                return true;
        } else {
            echo "Cargo no realizada";
            echo "</br><a class='btn btn-danger' href='index.php?vista=comprobar2'>Volver</a>";

            return false;
        }
    }

    function abonoadmin($benefi, $importe, $motivo, $hoy, $saldo)
    {
        echo "<link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css>";
        echo " <link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css>";

        $consulta = "INSERT into operacion (cuenta_titular,fecha,importe,Saldo,tipo_operacion,motivo) values(?,?,+?,?,'abono',?)";

        if ($pre = $this->conexion->prepare($consulta)) {
            echo "Abono realizado";
            echo "</br><a  class='btn btn-danger' href='index.php?vista=comprobar2'>Volver</a>";
            $pre->bind_param("ssdds", $benefi, $hoy, $importe, $saldo, $motivo);
            $pre->execute();
            if ($pre->fetch())
                return true;
        } else {
            echo "Abono no realizada";
            echo "</br><a class='btn btn-danger' href='index.php?vista=comprobar2'>Volver</a>";
            return false;
        }
    }

    function sacar1($benefi)
    {
        echo "<link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css>";
        echo " <link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css>";
        $consulta = "SELECT num_cuenta FROM cuenta WHERE num_cuenta= ?";
        if ($pre = $this->conexion->prepare($consulta)) {

            $pre->bind_param("s", $benefi);
            $pre->execute();

            $pre->bind_result($num_cuenta);

            if ($pre->fetch() > 0) {

                return true;
            } else {
                echo "No existe esta cuenta";
                echo "</br><a class='btn btn-danger' href='index.php?vista=comprobar2'>Volver</a>";

                return false;
            }
        }
    }

    function registrar($empresa)
    {
        echo "<link rel=stylesheet type=text/css href=estilos/estilos.css>";
        echo "<link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css>";
        echo " <link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css>";

        $sql = "INSERT into empresa (Nombre) values(?)";

        $pre = mysqli_prepare($this->conexion, $sql);

        mysqli_stmt_bind_param($pre, "s", $empresa1);

        $empresa1 = $empresa;

        if (mysqli_stmt_execute($pre)) {

            return true;
        } else {
            echo "Ya existe una empresa con este nombre.Revisa tus datos porfavor.
			<a  class='btn btn-danger' href='index.php?vista=salir'>Salir</a>";
            return false;
        }
    }

    function sacarem($empresa)
    {
        $consulta = "SELECT * FROM empresa WHERE Nombre = ?";
        if ($pre = $this->conexion->prepare($consulta)) {

            $pre->bind_param("s", $empresa);
            $pre->execute();

            $pre->bind_result($id_empresa, $nombre);

            if ($pre->fetch())
                $empresa = new empresa($id_empresa, $nombre);
            return $empresa;
        } else

            return false;
    }

    function registrar2($usuario, $pass, $nombre, $apellido, $dni, $empresa, $telefono, $fecha, $email,$cuenta)
    {
        $pass_encriptada=password_hash($pass, PASSWORD_DEFAULT);
        $result = '';
        for($i=0; $i<strlen($cuenta); $i++) {
            $char = substr($cuenta, $i, 1);
            $keychar = substr($pass_encriptada, ($i % strlen($pass_encriptada))-1, 1);
            $char = chr(ord($char)+ord($keychar));
            $result.=$char;
        }
        //Esto va para la base de datos
        $cuenta_enc=base64_encode($result);
       
        echo "<link rel=stylesheet type=text/css href=estilos/estilos.css>";
        echo "<link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css>";
        echo " <link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css>";

        $sql = "INSERT into usuarios (usuario,pass,nombre,apellido,dni,Empresa,Estado,Telefono,Fecha,Email,cuenta) values(?,?,?,?,?,?,'Desactivado',?,?,?,?)";

        $pre = mysqli_prepare($this->conexion, $sql);

        mysqli_stmt_bind_param($pre, "sssssiisss", $usuario1, $pass1, $nombre1, $apellido1, $dni1, $empresa1, $telefono1, $fecha1, $email1,$cuenta1);

        $usuario1 = $usuario;
        $pass1 = $pass_encriptada;
        $nombre1 = $nombre;
        $apellido1 = $apellido;
        $dni1 = $dni;
        $empresa1 = $empresa;
        $telefono1 = $telefono;
        $fecha1 = $fecha;
        $email1 = $email;
        $cuenta1=$cuenta_enc;

        if (mysqli_stmt_execute($pre)) {
            echo "</br>Tu cuenta a sido creada con exito.
					En un rato un administrador revisara tu cuenta y la activara.
					<a  class='btn btn-danger' href='index.php?vista=salir'>Salir</a>";
            return true;
        } else {
            echo "Ya existe una cuenta con estos datos.Revisa tus datos porfavor
					<a  class='btn btn-danger' href='index.php?vista=salir'>Salir</a>";
            return false;
        }
    }

    function activado($cliente)
    {
        echo "<link rel=stylesheet type=text/css href=estilos/estilos.css>";
        echo "<link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css>";
        echo " <link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css>";

        $sql = "UPDATE usuarios set Estado = 'Activo' where usuario = ?";
        $pre = mysqli_prepare($this->conexion, $sql);

        // Se indica los datos a reemplazar con su tipo
        mysqli_stmt_bind_param($pre, "s", $cliente);

        $cliente = $cliente;

        echo $this->obtenerErrorSQL();

        if ($result = mysqli_stmt_execute($pre)) {
            echo "</br><a class='btn btn-danger' href='index.php?vista=comprobar2'>Volver</a>";
            if (mysqli_affected_rows($this->conexion) > 0) {} else {}
        }
    }

    function cuenta($cuenta, $empresa)
    {
        echo "<link rel=stylesheet type=text/css href=estilos/estilos.css>";
        echo "<link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css>";
        echo " <link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css>";

        $consulta = "INSERT into cuenta (num_cuenta,saldo,Empresa) values(?,0,?)";

        $pre = mysqli_prepare($this->conexion, $consulta);

        mysqli_stmt_bind_param($pre, "ss", $cuenta1, $empresa1);

        $cuenta1 = $cuenta;
        $empresa1 = $empresa;

        if (mysqli_stmt_execute($pre)) {
            echo "Cuenta activada";
            return true;
        } else {
            echo "Ya existe una cuenta con este numero";
            echo "</br><a class='btn btn-danger' href='index.php?vista=comprobar2'>Volver</a>";
            return false;
        }
    }

    function sacarem2($cliente)
    {
        $consulta = "SELECT Empresa FROM usuarios WHERE usuario = ?";
        if ($pre = $this->conexion->prepare($consulta)) {

            $pre->bind_param("s", $cliente);
            $pre->execute();

            $pre->bind_result($empresa);

            if ($pre->fetch())

                return $empresa;
        } else

            return false;
    }

    function borrar($empresa)
    {
        echo "<link rel=stylesheet type=text/css href=estilos/estilos.css>";
        echo "<link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css>";
        echo " <link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css>";

        $sql = "DELETE  from empresa where Id_empresa=? ";

        $pre = mysqli_prepare($this->conexion, $sql);

        mysqli_stmt_bind_param($pre, "i", $empresa1);

        $empresa1 = $empresa;
        if ($result = mysqli_stmt_execute($pre)) {
            if (mysqli_affected_rows($this->conexion) > 0) {
                echo "</br><a class='btn btn-danger' href='index.php?vista=comprobar2'>Volver</a>";
            }
        }
    }

    function borrar1($empresa)
    {
        $sql = "DELETE  from usuarios where Empresa=? ";

        $pre = mysqli_prepare($this->conexion, $sql);

        mysqli_stmt_bind_param($pre, "i", $empresa1);

        $empresa1 = $empresa;
        if ($result = mysqli_stmt_execute($pre)) {
            if (mysqli_affected_rows($this->conexion) > 0) {}
        }
    }

    function borrar2($empresa)
    {
        $sql = "DELETE  from cuenta where Empresa=? ";

        $pre = mysqli_prepare($this->conexion, $sql);

        mysqli_stmt_bind_param($pre, "i", $empresa1);

        $empresa1 = $empresa;
        if ($result = mysqli_stmt_execute($pre)) {
            if (mysqli_affected_rows($this->conexion) > 0) {
            }
        }
    }

    function sacare($empresa)
    {
        $consulta = "SELECT * FROM empresa WHERE Id_empresa= ?";

        if ($pre = $this->conexion->prepare($consulta)) {

            $pre->bind_param("s", $empresa);
            $pre->execute();

            $pre->bind_result($id_empresa, $nombre);

            if ($pre->fetch())
                $empresa = new empresa($id_empresa, $nombre);
            return $empresa;
        } else

            return false;
    }

    function prestamo($empresa, $cantidad, $fecha, $interes, $cuanto, $finalidad, $aval)
    {
        echo "<link rel=stylesheet type=text/css href=estilos/estilos.css>";
        echo "<link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css>";
        echo " <link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css>";

        $sql = "INSERT into prestamos (empresa,cantidad,fecha,intereses,encuanto,estado,finalidad,aval) values(?,?,?,?,?,'En curso',?,?)";

        $pre = mysqli_prepare($this->conexion, $sql);

        mysqli_stmt_bind_param($pre, "sisssss", $empresa1, $cantidad1, $fecha1, $interes1, $cuanto1, $finalidad1, $aval1);

        $empresa1 = $empresa;
        $cantidad1 = $cantidad;
        $fecha1 = $fecha;
        $interes1 = $interes;
        $cuanto1 = $cuanto;
        $finalidad1 = $finalidad;
        $aval1 = $aval;

        if (mysqli_stmt_execute($pre)) {
            echo "Se a tramitado su credito, uno de nuestros agentes lo valorara.Revise su cuenta en un rato.";
            echo "</br><a class='btn btn-danger'href='#' onclick='window.close();'>Cerrar</a>";
            return true;
        } else {
            echo "Hemos tenido un error.Consulte con uno de nuestros agentes";
            echo "</br><a class='btn btn-danger'href='#' onclick='window.close();'>Cerrar</a>";
            return false;
        }
    }

    function tramite($empresa)
    {
        echo "<link rel=stylesheet type=text/css href=estilos/estilos.css>";
        echo "<link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css>";
        echo " <link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css>";

        $sql = "SELECT id_prestamos,empresa,cantidad,fecha,intereses,encuanto,estado,finalidad,aval from prestamos WHERE empresa = ?";

        $resultado = mysqli_query($this->conexion, $sql);

        $pre = mysqli_prepare($this->conexion, $sql);

        mysqli_stmt_bind_param($pre, "s", $empresa1);

        $empresa1 = $empresa;

        mysqli_stmt_execute($pre);

        $result = mysqli_stmt_bind_result($pre, $id_prestamo, $empresa, $cantidad, $fecha, $intereses, $encuanto, $estado, $finalidad, $aval);
        echo "<h1>Listado de sus prestamos</h1>";
        echo "<table class='table table-hover'>";
        echo "<tr class='info'>";
        echo "<td><b>Cantidad</b></td>";
        echo "<td><b>Fecha</b></td>";
        echo "<td><b>Interes</b></td>";
        echo "<td><b>Tiempo de devolucion</b></td>";
        echo "<td><b>Finalidad</b></td>";
        echo "<td><b>Aval de empresa</b></td>";
        echo "<td><b>Estado</b></td>";
        echo "</tr>";
        while (mysqli_stmt_fetch($pre)) {
            echo "<tr>";
            echo "<td>" . $cantidad . "&euro;</td><td>
						" . $fecha . "</td><td>" . $intereses . "%</td><td>" . $encuanto . "meses</td><td>" . $finalidad . "</td><td>" . $aval . "</td><td>" . $estado . "</td>";

            echo "</tr>";
        }
        echo "</table>";
    }

    function creditos()
	//Se le muestra al admin todos los creditos que han pedido los usuarios, el puede aceptarlo o denegarlos
    {
        echo "<link rel=stylesheet type=text/css href=estilos/estilos.css>";
        echo "<link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css>";
        echo " <link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css>";

        $sql = "SELECT id_prestamos,empresa,cantidad,fecha,intereses,encuanto,finalidad,aval from prestamos WHERE estado='En curso'";

        $resultado = mysqli_query($this->conexion, $sql);

        $pre = mysqli_prepare($this->conexion, $sql);

        mysqli_stmt_execute($pre);
        if ($result = mysqli_stmt_execute($pre)) {
            $result = mysqli_stmt_bind_result($pre, $id, $empresa, $cantidad, $fecha, $intereses, $encuanto, $finalidad, $aval);
            echo "<h1>Listado de prestamos</h1>";
            echo "<a id='mover' class='btn btn-danger' href='index.php?vista=comprobar2'>Volver</a>";
            echo "<table class='table table-hover'>";
            echo "<tr class='info'>";
            echo "<td><b>Empresa</b></td>";
            echo "<td><b>Cantidad</b></td>";
            echo "<td><b>Fecha</b></td>";
            echo "<td><b>Interes</b></td>";
            echo "<td><b>Tiempo de devolucion</b></td>";
            echo "<td><b>&#191;Empresa en aval?</b></td>";
            echo "<td></td>";
            echo "</tr>";
            while (mysqli_stmt_fetch($pre)) {
                echo "<tr>";
                echo "<td>" . $empresa . "</td><td>" . $cantidad . "&euro;</td><td>
						" . $fecha . "</td><td>" . $intereses . "%</td><td>" . $encuanto . "meses</td><td>" . $aval . "</td><td>         
                                <a class='btn btn-primary' href='index.php?vista=aceptar&id=" . $id . "&saldo=" . $cantidad . "&empresa=" . $empresa . "'>Aceptar</a>
								<a class='btn btn-warning' href='index.php?vista=denegar&id=" . $id . "'>Denegar </a>";

                echo "</tr>";
            }
            echo "</table>";
        } else {
            
        }
    }

    function activar($id)
    {
        echo "<link rel=stylesheet type=text/css href=estilos/estilos.css>";
        echo "<link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css>";
        echo " <link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css>";

        $sql = "UPDATE prestamos set estado = 'Aceptado' where id_prestamos = ?";
        $pre = mysqli_prepare($this->conexion, $sql);

        // Se indica los datos a reemplazar con su tipo
        mysqli_stmt_bind_param($pre, "i", $id);

        $ide = $id;

        echo $this->obtenerErrorSQL();

        if ($result = mysqli_stmt_execute($pre)) {
            header("Location: index.php?vista=comprobar2");
           
            if (mysqli_affected_rows($this->conexion) > 0) {} else {}
        }
    }

    function denegar($id)
    {
        echo "<link rel=stylesheet type=text/css href=estilos/estilos.css>";
        echo "<link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css>";
        echo " <link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css>";

        $sql = "UPDATE prestamos set estado = 'Denegado' where id_prestamos = ?";
        $pre = mysqli_prepare($this->conexion, $sql);

        // Se indica los datos a reemplazar con su tipo
        mysqli_stmt_bind_param($pre, "i", $id);

        $ide = $id;

        echo $this->obtenerErrorSQL();

        if ($result = mysqli_stmt_execute($pre)) {
            header("Location: index.php?vista=comprobar2");
          
            if (mysqli_affected_rows($this->conexion) > 0) {} else {}
        }
    }

    function scuenta($empresa)
    {
        $consulta = "select cuenta.num_cuenta from cuenta inner join empresa on cuenta.Empresa=empresa.Id_empresa WHERE 
				empresa.Nombre= ?;";
        if ($pre = $this->conexion->prepare($consulta)) {

            $pre->bind_param("s", $empresa);
            $pre->execute();

            $pre->bind_result($cuenta);

            if ($pre->fetch())

                return $cuenta;
        } else

            return false;
    }

    function activar1($titular, $importe, $motivo, $hoy, $saldo)
    {
        if (is_numeric($importe)) {
            echo "<link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css>";
            echo " <link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css>";

            $consulta = "INSERT into operacion (cuenta_titular,fecha,importe,saldo,tipo_operacion,motivo) values(?,?,?,?,'abono',?)";

            if ($pre = $this->conexion->prepare($consulta)) {
                echo "Transferencia realizada";

                $pre->bind_param("ssdds", $titular, $hoy, $importe, $saldo, $motivo);
                $pre->execute();
                if ($pre->fetch())
                    return true;
            } else {
                echo "Abono no realizada";

                return false;
            }
        } else {
            echo "importe no correcto";
            echo "</br><a class='btn btn-danger' href='index.php?vista=comprobar2'>Volver</a>";
        }
    }

    function modificar($user, $empresa)
    {
        $consulta = "SELECT * FROM usuarios WHERE usuario=?";
        if ($pre = $this->conexion->prepare($consulta)) {

            $pre->bind_param("s", $user);
            $pre->execute();

            $pre->bind_result($usuario, $pass, $nombre, $apellido, $dni, $Empresa, $estado, $telefono, $fecha, $email);

            if ($pre->fetch()) {

                $usuario = new usuario($usuario, $pass, $nombre, $apellido, $dni, $empresa, $estado, $telefono, $fecha, $email);
                return $usuario;
            } else {

                return false;
            }
        }
    }

    function modificarEmpresa($id, $nombre)
    {
        $sql = "UPDATE empresa set Nombre = ? where Id_empresa = ?";
        $pre = mysqli_prepare($this->conexion, $sql);

        // Se indica los datos a reemplazar con su tipo
        mysqli_stmt_bind_param($pre, "si", $nombre1, $id1);

        $nombre1 = $nombre;
        $id1 = $id;

        echo $this->obtenerErrorSQL();

        if ($result = mysqli_stmt_execute($pre)) {

            if (mysqli_affected_rows($this->conexion) > 0) {} else {}
        }
    }

    function modificarDatos($usuario, $pass, $nombre, $apellido, $dni, $telefono, $fecha, $email,$cuenta, $empresa)
    {
        $pass_enc=password_hash($pass, PASSWORD_DEFAULT);
        
        $result = '';
        for($i=0; $i<strlen($cuenta); $i++) {
            $char = substr($cuenta, $i, 1);
            $keychar = substr($pass_enc, ($i % strlen($pass_enc))-1, 1);
            $char = chr(ord($char)+ord($keychar));
            $result.=$char;
        }
        //Esto va para la base de datos
        $cuenta_enc=base64_encode($result);
        
        $sql = "UPDATE usuarios set usuario = ?,pass = ?, nombre = ?,
         apellido = ?, dni= ?, telefono = ?, fecha = ?, email = ?, cuenta = ? where Empresa = ?";
        $pre = mysqli_prepare($this->conexion, $sql);

        // Se indica los datos a reemplazar con su tipo
        mysqli_stmt_bind_param($pre, "sssssisssi", $usuario1, $pass1, $nombre1, $apellido1, $dni1, $telefono1, $fecha1, $email1,$cuenta1, $empresa1);

        $usuario1 = $usuario;
        $pass1 = $pass_enc;
        $nombre1 = $nombre;
        $apellido1 = $apellido;
        $dni1 = $dni;
        $telefono1 = $telefono;
        $fecha1 = $fecha;
        $email1 = $email;
        $cuenta1=$cuenta_enc;
        $empresa1 = $empresa;
        

        echo $this->obtenerErrorSQL();

        if ($result = mysqli_stmt_execute($pre)) {
            echo "<script type='text/javascript'>alert('se ha modificado');";
            echo "window.close()";
            echo "</script>";

            if (mysqli_affected_rows($this->conexion) > 0) {} else {}
        }else{
            echo "<script type='text/javascript'>alert('El nombre de usuario ya existe');";
            echo "window.close()";
            echo "</script>";
        }
    }

    function modificarCredito($id, $cantidad, $cuanto, $interes, $finalidad, $aval)
    {
        echo "<link rel=stylesheet type=text/css href=estilos/estilos.css>";
        echo "<link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css>";
        echo " <link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css>";

        $sql = "UPDATE prestamos set cantidad = ?,intereses = ?, encuanto = ?,
         finalidad = ?, aval= ?  where id_prestamos = ?";
        $pre = mysqli_prepare($this->conexion, $sql);

        mysqli_stmt_bind_param($pre, "iiisss", $cantidad1, $interes1, $cuanto1, $finalidad1, $aval1, $id1);

        $cantidad1 = $cantidad;
        $interes1 = $interes;
        $cuanto1 = $cuanto;
        $finalidad1 = $finalidad;
        $aval1 = $aval;
        $id1 = $id;

        echo $this->obtenerErrorSQL();

        if ($result = mysqli_stmt_execute($pre)) {
            echo "<script type='text/javascript'>alert('se ha modificado');";
            echo "window.close()";
            echo "</script>";

            if (mysqli_affected_rows($this->conexion) > 0) {} else {}
        }
    }
    
    function vermodi($empresa)
    {
        echo "<link rel=stylesheet type=text/css href=estilos/estilos.css>";
        echo "<link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css>";
        echo " <link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css>";
        
        $sql = "SELECT id_prestamos,empresa,cantidad,fecha,intereses,encuanto,estado,finalidad,aval from prestamos WHERE empresa = ? and estado='En curso'";
        
        $resultado = mysqli_query($this->conexion, $sql);
        
        $pre = mysqli_prepare($this->conexion, $sql);
        
        mysqli_stmt_bind_param($pre, "s", $empresa1);
        
        $empresa1 = $empresa;
        
        mysqli_stmt_execute($pre);
        
        $result = mysqli_stmt_bind_result($pre, $id_prestamo, $empresa, $cantidad, $fecha, $intereses, $encuanto, $estado, $finalidad, $aval);
        echo "<h1>Listado de sus prestamos</h1>";
        echo "<table class='table table-hover'>";
        echo "<tr class='info'>";
        echo "<td><b>Cantidad</b></td>";
        echo "<td><b>Fecha</b></td>";
        echo "<td><b>Interes</b></td>";
        echo "<td><b>Tiempo de devolucion</b></td>";
        echo "<td><b>Finalidad</b></td>";
        echo "<td><b>Aval de empresa</b></td>";
        echo "<td><b>Estado</b></td>";
        echo "</tr>";
        while (mysqli_stmt_fetch($pre)) {
            echo "<tr>";
            echo "<td>" . $cantidad . "&euro;</td><td>
						" . $fecha . "</td><td>" . $intereses . "%</td><td>" . $encuanto . "meses</td><td>" . $finalidad . "</td><td>" . $aval . "</td><td>" . $estado . "</td>
                            <td><a class='btn btn-warning' href='index.php?vista=modificarCredito&id=".$id_prestamo."&cantidad=".$cantidad."&interes=".$intereses."&encuanto=".$encuanto."&finalidad=".$finalidad."&aval=".$aval."'>Modificar </a></td>";
            
            echo "</tr>";
        }
        echo "</table>";
    }
    
    function añadirLogeo($user,$fecha,$hora){    
        $sql = "Insert into logeos values(?,?,?)";
        $pre = mysqli_prepare($this->conexion, $sql);
        // Se indica los datos a reemplazar con su tipo
        mysqli_stmt_bind_param($pre, "sss", $user,$hora,$fecha);
        
        
        $user1=$user;
        $hora1=$hora;
        $fecha1=$fecha;
        echo $this->obtenerErrorSQL();
        
        if ($result = mysqli_stmt_execute($pre)) {
            
            if (mysqli_affected_rows($this->conexion) > 0) {} else {}
        }
    }
    function comprobarPass($user,$clave){
        
        $sql = "select pass from usuarios where usuario= ? ";
        if ($pre = $this->conexion->prepare($sql)) {
            
            $pre->bind_param("s", $user);
            $pre->execute();
            
            $pre->bind_result($pass);
            
            if ($pre->fetch())
                return $pass;
            }
                
        
    }
    
}
?>