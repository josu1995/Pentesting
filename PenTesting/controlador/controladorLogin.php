<?php
require_once ("modelo/usuarioDB.php");
//*importar las clases del modelo
function comprobar(){
    
    $user = strip_tags($_POST["usuario"]);
    $clave =strip_tags( $_POST["clave"]);
	

	$miusuariodb = new usuarioDB();
	$miusuariodb->conectar ();
    
	
    $contra = $miusuariodb->comprobarPass($user, $clave);
    if(password_verify($clave, $contra)){    
	$resultado =$miusuariodb->obtenerUsuario($user,$contra);
	    $fecha=date("d/m/Y");
	    $hora = date("H:i:s");
	    $miusuariodb->añadirLogeo($user,$fecha,$hora);
		if($resultado->get_usuario()=="admin"){
		    $_SESSION["admin"]=true;
			require ("vista/admin.html");
		}else{
			if($resultado->get_estado()=="Desactivado"){
				require("vista/noacti.html");
			}else{		
			    $_SESSION["admin"]=false;
		$_SESSION["usuario"]=$user;
		$_SESSION["pass"]=$clave;
		$_SESSION["empresa"]=$resultado->get_empresa();		
		$_SESSION["nombre"]=$resultado->get_nombre();
		$_SESSION["apellido"]=$resultado->get_apellido();
		$_SESSION["dni"]=$resultado->get_dni();
		$_SESSION["telefono"]=$resultado->getTelefono();
		$_SESSION["fecha"]=$resultado->getFecha();
		$_SESSION["email"]=$resultado->getEmail();
		
		$string1=$resultado->getCuenta();
		$result = '';
		$string1 = base64_decode($string1);
		for($i=0; $i<strlen($string1); $i++) {
		    $char = substr($string1, $i, 1);
		    $keychar = substr($contra, ($i % strlen($contra))-1, 1);
		    $char = chr(ord($char)-ord($keychar));
		    $result.=$char;
		} 		
		
		$_SESSION["cuentab"]=$result;
        
		
		
		$empresa=$miusuariodb->sacare($_SESSION["empresa"]);
		$_SESSION["empre"]=$empresa->get_nombre();
		$resultado1=$miusuariodb->obtenerCuenta($resultado->get_empresa());
		$_SESSION["cuenta"]=$resultado1;
		$hoy=date("d/m/Y");
		
		$miusuariodb->mostrar2($resultado1,$hoy,$_SESSION["empre"]);
		
			}
		}
	}else{
	    $fecha=date("d/m/Y");
	    $hora = date("H:i:s");
	    $miusuariodb->añadirLogeo($user,$fecha,$hora);
		require("vista/error.html");
		require("vista/index.html");
	}
}
function mostrar(){
	$cuenta=$_SESSION["cuenta"];
	$hoy=date("d/m/Y");
	$empresa =$_SESSION["empre"];
	$miusuariodb = new usuarioDB();
	$miusuariodb->conectar ();
	
	$miusuariodb->mostrar2($cuenta,$hoy,$empresa);
	
	
}
function trans(){
	$titular=$_SESSION["cuenta"];
	$benefi=strip_tags($_POST["bene"]);
	$importe=strip_tags($_POST["cantidad"]);
	$motivo=strip_tags($_POST["motivo"]);
	$hoy=date("d/m/Y");
	
	
	
	$miusuariodb = new usuarioDB();
	$miusuariodb->conectar ();
	if($mirar=$miusuariodb->sacar($benefi)){
	//$miusuariodb->tranfe($titular, $benefi, $importe, $motivo,$hoy);
		
		
	$miusuariodb->sumar($importe,$benefi);
	$miusuariodb->restar($importe,$titular);
	//cargo
	$saldo=$miusuariodb->saldo($titular);
	
	//abono
	$saldo1=$miusuariodb->saldo($benefi);
	
	$miusuariodb->cargo($titular,$importe,$motivo,$hoy,$saldo->get_saldo());
	$miusuariodb->abono($benefi,$importe,$motivo,$hoy,$saldo1->get_saldo());
	}
}

function mostrar1(){
    $empresa = strip_tags($_POST["empresa"]);
	$hoy=date("d/m/Y");
	$miusuariodb = new usuarioDB();
	$miusuariodb->conectar ();
	$miusuariodb->mostrar1($empresa,$hoy);
	
	
}
function cargoadmin(){
    $benefi=strip_tags($_POST["bene"]);
    $importe=strip_tags($_POST["cantidad"]);
    $motivo=strip_tags($_POST["motivo"]);
	$hoy=date("d/m/Y");
	
	$miusuariodb = new usuarioDB();
	$miusuariodb->conectar ();
	if($mirar=$miusuariodb->sacar1($benefi)){
	$miusuariodb->restar($importe, $benefi);
	$saldo=$miusuariodb->saldo($benefi);
	
	$miusuariodb->cargoadmin($benefi,$importe,$motivo,$hoy,$saldo->get_saldo());
	}
}
function abonoadmin(){
    $benefi=strip_tags($_POST["bene"]);
    $importe=strip_tags($_POST["cantidad"]);
    $motivo=strip_tags($_POST["motivo"]);
	$hoy=date("d/m/Y");
	
	$miusuariodb = new usuarioDB();
	$miusuariodb->conectar ();
	if($mirar=$miusuariodb->sacar1($benefi)){
	$miusuariodb->sumar($importe, $benefi);
	$saldo=$miusuariodb->saldo($benefi);
	
	$miusuariodb->abonoadmin($benefi,$importe,$motivo,$hoy,$saldo->get_saldo());
	}
	
	
}
function registrar(){
    $nombre=strip_tags($_POST["nombre"]);
    $apellido=strip_tags($_POST["apellido"]);
    $dni=strip_tags($_POST["dni"]);
    $usuario=strip_tags($_POST["usuario"]);
    $pass=strip_tags($_POST["clave"]);
	
    $empresa=strip_tags($_POST["empresa"]);
	
    $telefono=strip_tags($_POST["telefono"]);
    $fecha=strip_tags($_POST["fecha"]);
    $email=strip_tags($_POST["email"]);
    $cuenta =strip_tags($_POST["cuenta"]);
	
	$miusuariodb = new usuarioDB();
	$miusuariodb->conectar ();
	
	if($miusuariodb->registrar($empresa)){
	$sacar = $miusuariodb->sacarem($empresa);
	$miusuariodb->registrar2($usuario, $pass, $nombre, $apellido, $dni, $sacar->get_id_empresa(),$telefono,$fecha,$email,$cuenta);
	}
}
function activar(){
    $cuenta = strip_tags($_POST["cuenta"]);
    $cliente =strip_tags ($_POST["cliente"]);
	
	$miusuariodb = new usuarioDB();
	$miusuariodb->conectar ();
	
	
	$empresa=$miusuariodb->sacarem2($cliente);
	if($miusuariodb->cuenta($cuenta,$empresa)){
		$miusuariodb->activado($cliente);
	}
	
}
function borrar(){
	
    $empresa = strip_tags($_POST["empresa"]);
	$miusuariodb = new usuarioDB();
	$miusuariodb->conectar ();
	
	$miusuariodb->borrar($empresa);
	$miusuariodb->borrar1($empresa);
	$miusuariodb->borrar2($empresa);
}
function prestamos(){
	
	$empresa=$_SESSION["empre"];
	$cantidad=strip_tags($_POST["cantidad"]);
	$fecha=date("d/m/Y");
	$interes=strip_tags($_POST["interes"]);
	$cuanto=strip_tags($_POST["cuanto"]);
	$finalidad =strip_tags($_POST["finalidad"]);
	$aval=strip_tags($_POST["elegir"]);
	
	$miusuariodb = new usuarioDB();
	$miusuariodb->conectar ();
	
	$miusuariodb->prestamo($empresa, $cantidad, $fecha, $interes, $cuanto,$finalidad,$aval);
	
}

function tramite(){
	
	$empresa=$_SESSION["empre"];
	
	$miusuariodb = new usuarioDB();
	$miusuariodb->conectar ();
	
	$miusuariodb->tramite($empresa);
}
function creditos(){
	$miusuariodb = new usuarioDB();
	$miusuariodb->conectar ();
	
	$miusuariodb->creditos();
}
//mirar
function aceptar(){
    $id=htmlspecialchars($_GET["id"]);
    $importe=htmlspecialchars($_GET["saldo"]);
    $empresa=htmlspecialchars($_GET["empresa"]);
	$motivo ="Credito";
	
	$hoy=date("d/m/Y");
	
	$miusuariodb = new usuarioDB();
	$miusuariodb->conectar ();
	//sacar la cuenta titular
	$cuenta = $miusuariodb->scuenta($empresa);
	//activar el credito
	$miusuariodb->activar($id);
	//sumar el saldo actual
	$miusuariodb->sumar($importe,$cuenta);
	//sacar el saldo actual
	$saldo=$miusuariodb->saldo($cuenta);
	$miusuariodb->activar1($cuenta, $importe, $motivo, $hoy, $saldo->get_saldo());
}
//mirar
function denegar(){
    $id =htmlspecialchars($_GET["id"]);
	$miusuariodb = new usuarioDB();
	$miusuariodb->conectar ();
	
	$miusuariodb->denegar($id);
	
}

function modificarDatos(){
    $nombre=strip_tags($_POST["nombre"]);
    $apellido=strip_tags($_POST["apellido"]);
    $dni=strip_tags($_POST["dni"]);
    $usuario=strip_tags($_POST["usuario"]);
    $pass=strip_tags($_POST["clave"]);
    $empresa=strip_tags($_POST["empresa"]);
    
    $telefono=strip_tags($_POST["telefono"]);
    $fecha=strip_tags($_POST["fecha"]);
    $email=strip_tags($_POST["email"]);
    
    $cuenta=strip_tags($_POST["cuenta"]);
    
    $miusuariodb = new usuarioDB();
    $miusuariodb->conectar ();
    
    $miusuariodb->modificarEmpresa($_SESSION["empresa"],$empresa);
    $miusuariodb->modificarDatos($usuario,$pass,$nombre,$apellido,$dni,$telefono,$fecha,$email,$cuenta,$_SESSION["empresa"]);
}
function modificarCredito(){
    $id=strip_tags($_POST["id"]);
    $cantidad=strip_tags($_POST["cantidad"]);
    $cuanto=strip_tags($_POST["encuanto"]);
    $interes=strip_tags($_POST["interes"]);
    $finalidad=strip_tags($_POST["finalidad"]);
    $aval=strip_tags($_POST["aval"]);

    
    $miusuariodb = new usuarioDB();
    $miusuariodb->conectar();
    
    $miusuariodb ->modificarCredito($id, $cantidad, $cuanto, $interes, $finalidad, $aval);
}

function vermodi(){
    $empresa=$_SESSION["empre"];
    $miusuariodb = new usuarioDB();
    $miusuariodb->conectar();
    $miusuariodb ->vermodi($empresa);   
}
?>